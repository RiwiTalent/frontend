@page "/Groups2"
@using Microsoft.AspNetCore.Authorization;
@using Microsoft.AspNetCore.Components.Authorization;
@using riwi.Services;
@inject GroupsServices GroupsServices; 
@using riwi.Models;
@attribute [Authorize]

<PageTitle>Grupos</PageTitle>
@if (!string.IsNullOrEmpty(errorMessage))
{
<MudAlert Severity="Severity.Error">@errorMessage</MudAlert>
}

<AuthorizeView>
    <Authorized>
        <MudContainer Class="d-flex flex-grow-1 flex-column">
            <!-- Botón y Agregar -->
            <MudContainer Class="d-flex justify-space-between flex-grow-1 gap-4 pa-3 ma-2">
                <MudIconButton Href="/Home" Icon="@Icons.Material.Rounded.KeyboardArrowLeft" Color="Color.Secondary" Class="border-solid border-2 mud-border-secondary pa-2"></MudIconButton>
            </MudContainer>

            <!-- Total grupos -->
            <MudContainer Class="d-flex justify-space-between flex-grow-1 gap-4 pa-3 ma-2">
                <MudText Typo="Typo.h5">Total grupos:<b>@GroupsCount</b></MudText>
            </MudContainer>
            <!-- Tabla de grupos -->
            <MudContainer Class="d-flex flex-grow-1 pa-3 ma-2">
                @if (_loading)
                {
                    <MudProgressLinear  Indeterminate="true" Color="Color.Info" Class="my-7"/>
                }
                else
                {
                    <MudTable Class="flex-grow-1 pa-2"
                              Items="@Group"
                              LoadingProgressColor="Color.Info"
                              Hover="true"
                              Filter="new Func<Group, bool>(FilterFunc1)">
                        
                        <ToolBarContent>
                            <MudTextField @bind-Value="searchString1" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
                            <MudSpacer/>
                            <MudButton Variant="Variant.Filled" EndIcon="@Icons.Material.Rounded.PersonAdd" Color="Color.Secondary">Crear grupo</MudButton>
                            <MudButton Variant="Variant.Filled" EndIcon="@Icons.Material.Rounded.PersonAdd" Color="Color.Secondary">Crear grupo</MudButton>
                        </ToolBarContent>
                        <HeaderContent>
                            <MudTh Class="text-center rounded"><MudTableSortLabel InitialDirection="SortDirection.None" SortBy="new Func<Group, object>(x => x.Name)">Nombre</MudTableSortLabel></MudTh>
                            <MudTh Class="text-center"><MudTableSortLabel InitialDirection="SortDirection.None" SortBy="new Func<Group, object>(x => x.Created_At)">Fecha Creación</MudTableSortLabel></MudTh>
                            <MudTh Class="text-center"><MudTableSortLabel InitialDirection="SortDirection.None" SortBy="new Func<Group, object>(x => x.Status)">Estado</MudTableSortLabel></MudTh>
                            <MudTh Class="text-center">Opciones</MudTh>
                        </HeaderContent>
                        <RowTemplate Context="row">
                            <MudTd><b>@(Group.IndexOf(row) + 1)</b></MudTd> <!-- Mostrar el índice + 1 -->
                            <MudTd><b>@row.Name</b></MudTd>
                            <MudTd><b>@row.Created_At.ToString("dd-MM-yyyy")</b></MudTd>
                            <MudTd>
                                <MudChip T="string" Color="@GetChipColor(row.Status)" Variant="Variant.Filled" Size="Size.Small" Class="px-4">
                                    @row.Status
                                </MudChip>
                            </MudTd>
                            <MudTd class="justify-center gap-2">
                                <MudIconButton Icon="@Icons.Material.Outlined.Edit" Title="Editar" Color="Color.Secondary" Class="border-solid border-2 mud-border-secondary pa-1"></MudIconButton>
                                <MudIconButton Icon="@Icons.Material.Outlined.RemoveRedEye" Title="Ver Detalles" Color="Color.Warning" Class="border-solid border-2 mud-border-warning pa-1"></MudIconButton>
                                <MudIconButton Icon="@Icons.Material.Outlined.Delete" Color="Color.Error" Title="Eliminar" Class="border-solid border-2 mud-border-error pa-1"></MudIconButton>
                            </MudTd>
                        </RowTemplate>
                        <PagerContent>
                            <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100, int.MaxValue }"
                                           RowsPerPageString="@rowsPerPageString"
                                           InfoFormat="@infoFormat"
                                           HideRowsPerPage="@hideRowsPerPage"
                                           HidePageNumber="@hidePageNumber"
                                           HidePagination="@hidePagination"/>
                        </PagerContent>
                    </MudTable>
                }
            </MudContainer>
        </MudContainer>
    </Authorized>
</AuthorizeView>
@code
{
    private List<Group> Group;
    private bool _loading = true;

    // Propiedad para el contador de grupos
    private int GroupsCount => Group?.Count ?? 0;
    private bool hidePageNumber;
    private bool hidePagination;
    private bool hideRowsPerPage;
    private string rowsPerPageString = "Filas por página:";
    private string infoFormat = "{first_item}-{last_item} de {all_items}";
    private string searchString1 = "";
    private string errorMessage;


    protected override async Task OnInitializedAsync()
    {
        try
        {
            Group = await GroupsServices.GetGroupsAsync();
        }
        catch (Exception ex)
        {
            errorMessage = "Hubo un error al cargar los grupos. Intente nuevamente más tarde.";
            Console.WriteLine($"Error al obtener grupos: {ex.Message}");
        }

        finally
        {
            _loading = false;
        }
    }
    private bool FilterFunc1(Group group) => FilterFunc(group, searchString1);

    private bool FilterFunc(Group group, string searchString)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;
        if (group.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (group.Status.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        return false;
    }
    
    private Color GetChipColor(string? status)
    {
        return status switch
        {
            "Active" => Color.Success,
            "Inactive" => Color.Error,
            _ => Color.Default,
        };
    }

}

<!-- private async Task OnSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            // Cuando el usuario presione "Enter", se aplicará el filtro
            await Task.Delay(100);  // Pequeño delay para asegurar que el texto ha sido actualizado antes de aplicar el filtro
            StateHasChanged();      // Esto refresca el componente y aplica el filtro con la nueva búsqueda
        }
    }
    -->